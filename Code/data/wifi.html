<!doctype html>
<html>
  <head>
    <title>WifiWhirl | Netzwerkkonfiguration</title>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" sizes="180x180" href="logo.png" />
    <meta name="theme-color" content="#4051b5" />
    <link rel="manifest" href="manifest.json" />
    <link
      rel="stylesheet"
      href="main.css"
      onload="
        this.media = 'all';
        this.onload = null;
      "
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <script src="function.js" type="text/javascript"></script>
    <script src="index.js" type="text/javascript"></script>
  </head>

  <body>
    <div id="site">
      <header>
        <form id="darkModeForm">
          <label class="switch">
            <input
              type="checkbox"
              id="darkModeToggle"
              onchange="toggleDarkMode()"
            />
            <span class="slider round"></span>
          </label>
        </form>
        <a href="./"
          ><div id="header">
            <span>Netzwerkkonfiguration</span><span>WifiWhirl</span>
          </div></a
        >
        <a href="javascript:void(0);" class="topnavicon" onclick="topNav()"></a>
      </header>

      <div class="topnav" id="topnav">
        <a href="./">Dashboard</a>
        <a href="automation.html">Automatisierung</a>
        <a href="smartschedule.html">Smart Schedule</a>
        <a href="config.html">SPA-Konfiguration</a>
        <a href="webconfig.html">Web-Konfiguration</a>
        <a href="mqtt.html">MQTT-Konfiguration</a>
        <a href="wifi.html" class="active">Netzwerkkonfiguration</a>
        <a href="hwconfig.html">Pumpenkonfiguration</a>
        <a href="/restart/">WifiWhirl Modul neu starten</a>
      </div>

      <section>
        <h2>WLAN-Einstellungen:</h2>
        <table>
          <tr style="display: none">
            <td>
              <label for="enableAp">Automatisch mit WLAN verbinden:</label>
            </td>
            <td><input type="checkbox" id="enableAp" /></td>
          </tr>
          <tr>
            <td>WLAN Name (SSID):</td>
            <td><input type="text" id="apSsid" /></td>
          </tr>
          <tr>
            <td>Passwort (PSK):</td>
            <td><input type="password" id="apPwd" /></td>
          </tr>
          <tr>
            <td colspan="2" style="text-align: center; padding-top: 10px">
              <button id="saveWlan" class="button" onclick="saveWlanConfig()">
                WLAN-Verbindung speichern
              </button>
            </td>
          </tr>
        </table>
      </section>

      <section>
        <h2>Statische IP-Adresse:</h2>
        <table>
          <tr>
            <td>
              <label for="enableStaticIp4">
                Statische IP-Adresse aktivieren:
              </label>
            </td>
            <td>
              <input
                type="checkbox"
                id="enableStaticIp4"
                onchange="toggleStaticIpFields()"
              />
            </td>
          </tr>
          <tr class="staticIpField">
            <td>IP-Adresse:</td>
            <td>
              <input
                type="text"
                id="ip4Address"
                maxlength="15"
                style="width: 185px"
              />
            </td>
          </tr>
          <tr class="staticIpField">
            <td>Subnetzmaske:</td>
            <td>
              <input
                type="text"
                id="ip4Subnet"
                maxlength="15"
                style="width: 185px"
              />
            </td>
          </tr>
          <tr class="staticIpField">
            <td>Gateway:</td>
            <td>
              <input
                type="text"
                id="ip4Gateway"
                maxlength="15"
                style="width: 185px"
              />
            </td>
          </tr>
          <tr class="staticIpField">
            <td>DNS-Server (primär):</td>
            <td>
              <input
                type="text"
                id="ip4DnsPrimary"
                maxlength="15"
                style="width: 185px"
              />
            </td>
          </tr>
          <tr class="staticIpField">
            <td>DNS-Server (sekundär):</td>
            <td>
              <input
                type="text"
                id="ip4DnsSecondary"
                maxlength="15"
                style="width: 185px"
              />
            </td>
          </tr>
          <tr>
            <td colspan="2" style="text-align: center; padding-top: 10px">
              <button
                id="saveStaticIp"
                class="button"
                onclick="saveStaticIpConfig()"
              >
                IP-Adresskonfiguration speichern
              </button>
            </td>
          </tr>
        </table>
      </section>

      <section>
        <h2>Zeit-Server (NTP):</h2>
        <table>
          <tr>
            <td>Domänenname oder IP-Adresse:</td>
            <td>
              <input
                type="text"
                id="ip4NTP"
                maxlength="30"
                style="width: 185px"
              />
            </td>
          </tr>
          <tr>
            <td colspan="2" style="text-align: center; padding-top: 10px">
              <button id="saveNtp" class="button" onclick="saveNtpConfig()">
                Zeitserver Einstellung speichern
              </button>
            </td>
          </tr>
        </table>
      </section>

      <section>
        <h2>Fallback WLAN:</h2>
        <table>
          <tr style="margin-bottom: 30px">
            <span
              >Wenn das WifiWhirl Modul keine Verbindung zu deinem WLAN herstellen
              kann (z. B. bei falschem Passwort, Routerwechsel oder
              Netzwerkausfall), öffnet es automatisch einen eigenen WLAN-Zugangspunkt
              namens <strong id="fallbackApName">...</strong>.
              Verbinde dich mit diesem Netzwerk und dem Passwort auf dem
              Aufkleber auf deinem Modul oder der mitgelieferten Anleitung, um die WLAN-Einstellungen
              neu zu konfigurieren.</span
            >
          </tr>
          <tr>
            <td><label for="enableWM">Fallback WLAN aktivieren:</label></td>
            <td>
              <input
                type="checkbox"
                id="enableWM"
                onchange="confirmDisableWM(this)"
              />
            </td>
          </tr>
          <tr>
            <td colspan="2" style="text-align: center; padding-top: 10px">
              <button
                id="saveFallback"
                class="button"
                onclick="saveFallbackConfig()"
              >
                Fallback Einstellung speichern
              </button>
            </td>
          </tr>
        </table>
      </section>

      <section>
        <h2>Netzwerkeinstellungen auf Werkseinstellungen zurücksetzen:</h2>
        <p>
          Setzt alle Netzwerkeinstellungen auf die Werkseinstellungen zurück.
          Dabei werden folgende Einstellungen gelöscht:
        </p>
        <ul style="margin: 10px 0; padding-left: 20px">
          <li>Gespeicherter WLAN-Name und Passwort</li>
          <li>Statische IP-Adresse und DNS-Einstellungen</li>
          <li>Benutzerdefinierter NTP-Server</li>
        </ul>
        <p>
          Nach dem Zurücksetzen startet das WifiWhirl-Modul neu und öffnet
          automatisch den Zugangspunkt <strong id="resetApName">...</strong>.
          Verbinde dich mit diesem Netzwerk und dem Passwort auf dem
          Aufkleber auf deinem Modul oder der mitgelieferten Anleitung, um die WLAN-Einstellungen
          neu zu konfigurieren.
        </p>
        <p style="text-align: center">
          <button id="resetwifi" class="button_red" onclick="resetWifi()">
            Auf Werkseinstellungen zurücksetzen
          </button>
        </p>
      </section>

      <footer>
        <p class="center">
          <span><a href="info.html">Softwareinfo</a></span>
        </p>
      </footer>
    </div>

    <script>
      // AP name - populated from backend, used by reset dialog
      var apName = "";

      loadNetworkConfig();

      function loadNetworkConfig() {
        var req = new XMLHttpRequest();
        req.open("POST", "/getwifi/");
        req.send();
        req.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var json = JSON.parse(req.responseText);
            console.log(json);

            document.getElementById("enableAp").checked = json.enableAp;
            document.getElementById("apSsid").value = json.apSsid;
            document.getElementById("apPwd").value = json.apPwd;
            document.getElementById("enableWM").checked = json.enableWM;

            document.getElementById("enableStaticIp4").checked =
              json.enableStaticIp4;
            document.getElementById("ip4Address").value = json.ip4Address;
            document.getElementById("ip4Gateway").value = json.ip4Gateway;
            document.getElementById("ip4Subnet").value = json.ip4Subnet;
            document.getElementById("ip4DnsPrimary").value = json.ip4DnsPrimary;
            document.getElementById("ip4DnsSecondary").value =
              json.ip4DnsSecondary;
            document.getElementById("ip4NTP").value = json.ip4NTP;

            // Store and display fallback AP name
            apName = json.wmApName || "wifiwhirl";
            document.getElementById("fallbackApName").textContent = apName;
            document.getElementById("resetApName").textContent = apName;

            // Set initial visibility of static IP fields
            toggleStaticIpFields();
          }
        };
      }

      function confirmDisableWM(elem) {
        if (elem.checked) return;
        var msg =
          "Achtung!\n\n" +
          "Mit dem Deaktivieren des Fallback WLAN kannst du dein WifiWhirl Modul " +
          "mit keinem neuen WLAN Netz verbinden, ohne das Modul zurückzusetzen.\n\n" +
          "Bist du dir sicher, dass du das Fallback WLAN deaktivieren möchtest?";
        if (!confirm(msg)) {
          elem.checked = true; // revert change
        }
      }

      /**
       * Toggle visibility of static IP address fields based on checkbox
       */
      function toggleStaticIpFields() {
        var enabled = document.getElementById("enableStaticIp4").checked;
        var fields = document.querySelectorAll(".staticIpField");
        for (var i = 0; i < fields.length; i++) {
          fields[i].style.display = enabled ? "" : "none";
        }
      }

      /**
       * Show restart page with countdown and auto-redirect
       */
      function showRestartPage(reason) {
        document.open();
        document.write(
          "<!DOCTYPE html>" +
            "<html>" +
            "<head>" +
            "<title>WifiWhirl | Neustart</title>" +
            '<meta charset="utf-8" />' +
            '<meta name="viewport" content="width=device-width, initial-scale=1" />' +
            "<style>" +
            "body { font-family: sans-serif; text-align: center; padding: 50px; margin: 0; background: #f5f5f5; }" +
            "h1 { color: #4051b5; margin-bottom: 20px; }" +
            "p { font-size: 18px; margin: 20px; color: #333; }" +
            ".info { color: #666; font-size: 16px; }" +
            ".btn { display: inline-block; margin-top: 30px; padding: 10px 20px; background: #4051b5; color: white; text-decoration: none; border-radius: 5px; }" +
            ".btn:hover { background: #2c3a8f; }" +
            "</style>" +
            "</head>" +
            "<body>" +
            "<h1>WifiWhirl startet neu...</h1>" +
            "<p>" +
            reason +
            "</p>" +
            '<p class="info">Die Netzwerkkonfiguration wird aktualisiert.</p>' +
            '<p class="info">Bitte warte ca. 30 Sekunden...</p>' +
            '<a href="/" class="btn">Zurück zur Übersicht</a>' +
            "<script>" +
            'setTimeout(function() { window.location.href = "/"; }, 30000);' +
            "<\/script>" +
            "</body>" +
            "</html>",
        );
        document.close();
      }

      /**
       * Helper: send partial config to /setwifi/ and handle restart response
       */
      function sendPartialConfig(buttonId, data) {
        var btn = document.getElementById(buttonId);
        var originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = "Wird gespeichert...";

        function showResult(text, duration) {
          btn.innerHTML = text;
          setTimeout(function () {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }, duration);
        }

        var req = new XMLHttpRequest();
        req.open("POST", "/setwifi/");

        req.onload = function () {
          if (req.status == 200) {
            try {
              var response = JSON.parse(req.responseText);
              if (response.restart === true) {
                showRestartPage(response.reason);
                return;
              }
              if (response.saved === true) {
                showResult("gespeichert &check;", 4000);
                return;
              }
            } catch (e) {
              // Non-JSON response
            }
            showResult("Keine Änderung &check;", 4000);
          } else {
            showResult("Fehler!", 3000);
          }
        };

        req.onerror = function () {
          showResult("Verbindungsfehler!", 3000);
        };

        req.send(JSON.stringify(data));
        console.log(data);
      }

      /**
       * Save WLAN settings only (SSID + password)
       */
      function saveWlanConfig() {
        if (!validatePassword("apPwd")) return;

        sendPartialConfig("saveWlan", {
          enableAp: document.getElementById("enableAp").checked,
          apSsid: document.getElementById("apSsid").value,
          apPwd: document.getElementById("apPwd").value,
        });

        document.getElementById("apPwd").value = "<Passwort eingeben>";
      }

      /**
       * Save fallback WiFi setting only
       */
      function saveFallbackConfig() {
        sendPartialConfig("saveFallback", {
          enableWM: document.getElementById("enableWM").checked,
        });
      }

      /**
       * Save static IP settings only
       */
      function saveStaticIpConfig() {
        sendPartialConfig("saveStaticIp", {
          enableStaticIp4: document.getElementById("enableStaticIp4").checked,
          ip4Address: document.getElementById("ip4Address").value,
          ip4Gateway: document.getElementById("ip4Gateway").value,
          ip4Subnet: document.getElementById("ip4Subnet").value,
          ip4DnsPrimary: document.getElementById("ip4DnsPrimary").value,
          ip4DnsSecondary: document.getElementById("ip4DnsSecondary").value,
        });
      }

      /**
       * Save NTP server setting only
       */
      function saveNtpConfig() {
        sendPartialConfig("saveNtp", {
          ip4NTP: document.getElementById("ip4NTP").value,
        });
      }

      function resetWifi() {
        var msg =
          "Achtung!\n\n" +
          "Alle Netzwerkeinstellungen (WLAN, IP, NTP) werden gelöscht " +
          "und auf die Werkseinstellungen zurückgesetzt.\n\n" +
          "Das Modul startet danach neu und öffnet das WLAN " +
          '"' + apName + '".\n\n' +
          "Möchtest du wirklich fortfahren?";
        if (confirm(msg)) {
          var req = new XMLHttpRequest();
          req.open("GET", "/resetwifi/");
          req.send();
          document.open();
          document.write(
            "<!DOCTYPE html>" +
              "<html>" +
              "<head>" +
              "<title>WifiWhirl | Zurückgesetzt</title>" +
              '<meta charset="utf-8" />' +
              '<meta name="viewport" content="width=device-width, initial-scale=1" />' +
              "<style>" +
              "body { font-family: sans-serif; text-align: center; padding: 50px; margin: 0; background: #f5f5f5; }" +
              "h1 { color: #e53935; margin-bottom: 20px; }" +
              "p { font-size: 18px; margin: 20px; color: #333; }" +
              ".info { color: #666; font-size: 16px; }" +
              "</style>" +
              "</head>" +
              "<body>" +
              "<h1>Netzwerk zurückgesetzt</h1>" +
              "<p>Dein WifiWhirl-Modul startet jetzt neu.</p>" +
              '<p class="info">Verbinde dich mit dem WLAN <strong>' +
              apName +
              "</strong> und dem Passwort auf der Rückseite deines Moduls, " +
              "um deine WLAN-Verbindung erneut einzurichten.</p>" +
              "</body>" +
              "</html>",
          );
          document.close();
        }
      }
    </script>
    <script src="darkmode.js" type="text/javascript"></script>
  </body>
</html>
