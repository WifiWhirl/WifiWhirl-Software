<!doctype html>
<html lang="de" ontouchmove>
  <head>
    <title>WifiWhirl</title>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" sizes="180x180" href="logo.png" />
    <meta name="theme-color" content="#4051b5" />
    <link rel="manifest" href="manifest.json" />
    <link
      rel="stylesheet"
      href="main.css"
      onload="
        this.media = 'all';
        this.onload = null;
      "
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <script src="function.js" type="text/javascript"></script>
    <script src="index.js" type="text/javascript"></script>
  </head>

  <body>
    <div id="site">
      <header>
        <form id="darkModeForm">
          <label class="switch">
            <input
              type="checkbox"
              id="darkModeToggle"
              onchange="toggleDarkMode()"
            />
            <span class="slider round moon"></span>
          </label>
        </form>
        <a href="./"
          ><div id="header">
            <span>Willkommen</span><span id="fw">WifiWhirl</span>
          </div></a
        >
        <a href="javascript:void(0);" class="topnavicon" onclick="topNav()"></a>
      </header>

      <div class="topnav" id="topnav">
        <a href="./" class="active">Dashboard</a>
        <a href="automation.html">Automatisierung</a>
        <a href="smartschedule.html">Smart Schedule</a>
        <a href="config.html">SPA-Konfiguration</a>
        <a href="webconfig.html">Web-Konfiguration</a>
        <a href="mqtt.html">MQTT-Konfiguration</a>
        <a href="wifi.html">Netzwerkkonfiguration</a>
        <a href="hwconfig.html">Pumpenkonfiguration</a>
        <a href="/restart/">WifiWhirl Modul neu starten</a>
      </div>

      <section id="sectionDisplay">
        <table>
          <tr>
            <td class="center"><div id="display">DSP</div></td>
          </tr>
        </table>
      </section>

      <section id="sectionTemperature">
        <div class="visualapproach"></div>
        <h2>Temperatur</h2>
        <table class="fixed">
          <tr>
            <td>Aktuell:</td>
            <td>
              <span id="atlabel">unbek.</span> °<span id="unitcf1">C</span>
            </td>
          </tr>
          <tr>
            <td>Ziel:</td>
            <td>
              <span id="ttlabel">unbek.</span> °<span id="unitcf3">C</span>
            </td>
          </tr>
        </table>
      </section>

      <section id="sectionControl">
        <h2>Steuerung</h2>
        <table id="tableSlider">
          <tr>
            <td style="width: 40%">Zieltemperatur</td>
            <td style="width: 50%">
              <input
                type="range"
                id="temp"
                min="20"
                max="40"
                step="1"
                value="20"
                onmousemove="showpreviewval('temp', 'sliderTempVal')"
                onmousedown="showpreviewval('temp', 'sliderTempVal')"
                ontouchmove="showpreviewval('temp', 'sliderTempVal')"
                onmouseup="sendCommand('setTarget')"
                ontouchend="sendCommand('setTarget')"
              />
            </td>
            <td style="width: 10%; text-align: right">
              <span id="sliderTempVal">unbek.</span> °
            </td>
          </tr>
          <tr>
            <td>Umgebungstemp.</td>
            <td>
              <input
                type="range"
                id="amb"
                min="-20"
                max="40"
                step="1"
                value="20"
                onmousemove="showpreviewval('amb', 'sliderAmbVal')"
                onmousedown="showpreviewval('amb', 'sliderAmbVal')"
                ontouchmove="showpreviewval('amb', 'sliderAmbVal')"
                onmouseup="sendCommand('setAmbient')"
                ontouchend="sendCommand('setAmbient')"
              />
            </td>
            <td style="text-align: right">
              <span id="sliderAmbVal">unbek.</span> °
            </td>
          </tr>
          <tr>
            <td>
              Helligkeit
              <span
                data-text="Wenn auf '0' eingestellt, ist das Display und alle Tasten auf der Pumpe komplett gedimmt (ausgeschaltet), leuchten jedoch 5 Sekunden lang auf, wenn eine Taste gedrückt wird."
                class="tooltip"
                >?</span
              >
            </td>
            <td>
              <input
                type="range"
                id="brt"
                min="0"
                max="8"
                step="1"
                value="7"
                onmousemove="showpreviewval('brt', 'sliderBrtVal')"
                onmousedown="showpreviewval('brt', 'sliderBrtVal')"
                ontouchmove="showpreviewval('brt', 'sliderBrtVal')"
                onmouseup="sendCommand('setBrightness')"
                ontouchend="sendCommand('setBrightness')"
              />
            </td>
            <td style="text-align: right">
              <span id="sliderBrtVal">unbek.</span>
            </td>
          </tr>
        </table>

        <table id="tableSelector" class="fixed">
          <tr>
            <td class="center">Zieltemperatur</td>
            <td class="center">Umgebungstemp.</td>
            <td class="center">
              Helligkeit
              <span
                data-text="Wenn auf '0' eingestellt, ist das Display und alle Tasten auf der Pumpe komplett gedimmt (ausgeschaltet), leuchten jedoch 5 Sekunden lang auf, wenn eine Taste gedrückt wird."
                class="tooltip left"
                >?</span
              >
            </td>
          </tr>
          <tr>
            <td class="center">
              <div class="selector">
                <button
                  onclick="
                    increaseNumber('selectorTemp');
                    sendCommand('setTargetSelector');
                  "
                  class="selectorbutton selectortop"
                >
                  ᐱ
                </button>
                <input
                  style="display: none"
                  type="number"
                  id="selectorTemp"
                  min="20"
                  max="40"
                  step="1"
                  value="20"
                  class="selectorvalue"
                  onchange="sendCommand('setTargetSelector')"
                />
                <div class="wrapper degrees">
                  <span class="numDisplay"></span>
                </div>
                <button
                  onclick="
                    decreaseNumber('selectorTemp');
                    sendCommand('setTargetSelector');
                  "
                  class="selectorbutton selectorbottom"
                >
                  ᐯ
                </button>
              </div>
            </td>
            <td class="center">
              <div class="selector">
                <button
                  onclick="
                    increaseNumber('selectorAmb');
                    sendCommand('setAmbientSelector');
                  "
                  class="selectorbutton selectortop"
                >
                  ᐱ
                </button>
                <input
                  style="display: none"
                  type="number"
                  id="selectorAmb"
                  min="-40"
                  max="60"
                  step="1"
                  value="20"
                  class="selectorvalue"
                  onchange="sendCommand('setAmbientSelector')"
                />
                <div class="wrapper degrees">
                  <span class="numDisplay"></span>
                </div>
                <button
                  onclick="
                    decreaseNumber('selectorAmb');
                    sendCommand('setAmbientSelector');
                  "
                  class="selectorbutton selectorbottom"
                >
                  ᐯ
                </button>
              </div>
            </td>
            <td class="center">
              <div class="selector">
                <button
                  onclick="
                    increaseNumber('selectorBrt');
                    sendCommand('setBrightnessSelector');
                  "
                  class="selectorbutton selectortop"
                >
                  ᐱ
                </button>
                <input
                  style="display: none"
                  type="number"
                  id="selectorBrt"
                  min="0"
                  max="8"
                  step="1"
                  value="7"
                  class="selectorvalue"
                  onchange="sendCommand('setBrightnessSelector')"
                />
                <div class="wrapper">
                  <span class="numDisplay noleft"></span>
                </div>
                <button
                  onclick="
                    decreaseNumber('selectorBrt');
                    sendCommand('setBrightnessSelector');
                  "
                  class="selectorbutton selectorbottom"
                >
                  ᐯ
                </button>
              </div>
            </td>
          </tr>
        </table>
      </section>

      <section id="sectionButtons">
        <h2>Tasten</h2>
        <table>
          <colgroup>
            <col />
            <col style="width: 25%" />
            <col />
            <col style="width: 25%" />
          </colgroup>
          <tr>
            <td class="right">Aus/Ein</td>
            <td>
              <label class="switch">
                <input
                  type="checkbox"
                  id="ONOFF"
                  onchange="sendCommand('togglePWR')"
                />
                <span class="slider round"></span>
              </label>
            </td>
            <td class="right">Tastensperre</td>
            <td>
              <label class="switch">
                <input
                  type="checkbox"
                  id="LCK"
                  onchange="sendCommand('toggleLCK')"
                />
                <span class="slider round"></span>
              </label>
            </td>
          </tr>
          <tr>
            <td class="right">Airjet</td>
            <td>
              <label class="switch">
                <input
                  type="checkbox"
                  id="AIR"
                  onchange="sendCommand('toggleBubbles')"
                />
                <span class="slider round"></span>
              </label>
            </td>
            <td class="right">Heizung</td>
            <td>
              <label class="switch">
                <input
                  type="checkbox"
                  id="HTR"
                  onchange="sendCommand('toggleHeater')"
                />
                <span id="htrspan" class="slider round"></span>
              </label>
            </td>
          </tr>
          <tr>
            <td class="right">Pumpe</td>
            <td>
              <label class="switch">
                <input
                  type="checkbox"
                  id="FLT"
                  onchange="sendCommand('togglePump')"
                />
                <span class="slider round"></span>
              </label>
            </td>
            <td class="right" style="white-space: nowrap">Einheit °F/°C</td>
            <td>
              <label class="switch">
                <input
                  type="checkbox"
                  id="UNT"
                  onchange="sendCommand('toggleUnit')"
                />
                <span class="slider round"></span>
              </label>
            </td>
          </tr>
          <tr>
            <td id="jets" class="right">Hydrojet</td>
            <td id="jetsswitch">
              <label class="switch">
                <input
                  type="checkbox"
                  id="HJT"
                  onchange="sendCommand('toggleHydroJets')"
                />
                <span class="slider round"></span>
              </label>
            </td>
          </tr>
        </table>
      </section>

      <section id="sectionTimer">
        <h2>Timer</h2>
        <table>
          <tr>
            <td>
              Zugabe von Chlor<br /><span class="label-subtle"
                >Zuletzt: <span id="cltimer">unbek.</span></span
              >
            </td>
            <td>
              <button
                id="cltimerbtn"
                class="button"
                onclick="
                  if (
                    confirm(
                      'Möchtest du den Timer für die Chlorzugabe wirklich zurücksetzen?',
                    )
                  ) {
                    buttonConfirm(this);
                    sendCommand('resetTimerChlorine');
                  }
                "
              >
                zurücksetzen
              </button>
            </td>
          </tr>
          <tr>
            <td>
              Filterreinigung<br /><span class="label-subtle"
                >Zuletzt: <span id="fctimer">unbek.</span></span
              >
            </td>
            <td>
              <button
                id="fctimerbtn"
                class="button"
                onclick="
                  if (
                    confirm(
                      'Möchtest du den Timer für die Filterreinigung wirklich zurücksetzen?',
                    )
                  ) {
                    buttonConfirm(this);
                    sendCommand('resetTimerCleanFilter');
                  }
                "
              >
                zurücksetzen
              </button>
            </td>
          </tr>
          <tr>
            <td>
              Filterwechsel<br /><span class="label-subtle"
                >Zuletzt: <span id="ftimer">unbek.</span></span
              >
            </td>
            <td>
              <button
                id="ftimerbtn"
                class="button"
                onclick="
                  if (
                    confirm(
                      'Möchtest du den Timer für den Filterwechsel wirklich zurücksetzen?',
                    )
                  ) {
                    buttonConfirm(this);
                    sendCommand('resetTimerFilter');
                  }
                "
              >
                zurücksetzen
              </button>
            </td>
          </tr>
          <tr>
            <td>
              Wasserwechsel<br /><span class="label-subtle"
                >Zuletzt: <span id="wctimer">unbek.</span></span
              >
            </td>
            <td>
              <button
                id="wctimerbtn"
                class="button"
                onclick="
                  if (
                    confirm(
                      'Möchtest du den Timer für den Wasserwechsel wirklich zurücksetzen?',
                    )
                  ) {
                    buttonConfirm(this);
                    sendCommand('resetTimerWaterChange');
                  }
                "
              >
                zurücksetzen
              </button>
            </td>
          </tr>
        </table>
      </section>

      <section id="sectionWaterQuality">
        <div style="display: flex; align-items: center; gap: 8px">
          <h2 style="margin: 0">Wasserqualität</h2>
          <span
            class="tooltip"
            data-text="In der Web-Konfiguration können zusätzliche Messungen für Alkalinität und Cyanursäure aktiviert werden."
            >?</span
          >
        </div>
        <table class="fixed">
          <tr>
            <td>pH-Wert</td>
            <td>
              <input
                type="number"
                id="phinput"
                class="wq-input"
                lang="de"
                min="0"
                max="14"
                step="0.1"
                value="7.2"
                inputmode="decimal"
                oninput="onPhInput()"
              />
            </td>
          </tr>
          <tr>
            <td colspan="2" class="wq-info-row">
              Idealwert: 7,2 - 7,6 ·
              <span class="label-subtle"
                >Zuletzt: <span id="phtimer">unbek.</span></span
              >
            </td>
          </tr>
          <tr>
            <td>Chlor (mg/L)</td>
            <td>
              <input
                type="number"
                id="clinput"
                class="wq-input"
                lang="de"
                min="0"
                max="10"
                step="0.1"
                value="1.0"
                inputmode="decimal"
                oninput="onClInput()"
              />
            </td>
          </tr>
          <tr>
            <td colspan="2" class="wq-info-row">
              Idealwert: 1,0 - 3,0 ·
              <span class="label-subtle"
                >Zuletzt: <span id="cltimer2">unbek.</span></span
              >
            </td>
          </tr>
          <tr id="rowCyaValue">
            <td>Cyanursäure (mg/L)</td>
            <td>
              <input
                type="number"
                id="cyainput"
                class="wq-input"
                min="0"
                max="200"
                step="1"
                value="30"
                inputmode="numeric"
                oninput="onCyaInput()"
              />
            </td>
          </tr>
          <tr id="rowCyaInfo">
            <td colspan="2" class="wq-info-row">
              Idealwert: 30 - 50 ·
              <span class="label-subtle"
                >Zuletzt: <span id="cyatimer">unbek.</span></span
              >
            </td>
          </tr>
          <tr id="rowAlkValue">
            <td>Alkalinität (mg/L)</td>
            <td>
              <input
                type="number"
                id="alkinput"
                class="wq-input"
                min="0"
                max="300"
                step="1"
                value="100"
                inputmode="numeric"
                oninput="onAlkInput()"
              />
            </td>
          </tr>
          <tr id="rowAlkInfo">
            <td colspan="2" class="wq-info-row">
              Idealwert: 80 - 120 ·
              <span class="label-subtle"
                >Zuletzt: <span id="alktimer">unbek.</span></span
              >
            </td>
          </tr>
        </table>
      </section>

      <section id="sectionTotals">
        <h2>Zähler</h2>
        <table class="fixed">
          <tr>
            <td>Aktuelle Zeit:</td>
            <td><span id="time">unbek.</span></td>
          </tr>
          <tr>
            <td>
              Bereit in:
              <span
                data-text="Funktioniert am besten, wenn die Umgebungstemperatur automatisch ermittelt wird und der Wasserinhalt angegeben ist (SPA-Konfiguration)."
                class="tooltip"
                >?</span
              >
            </td>
            <td><span id="t2r">unbek.</span></td>
          </tr>
          <tr>
            <td>
              Laufzeit:
              <span
                data-text="Gesamte Betriebszeit des WifiWhirl Moduls seit dem Zurücksetzen des Zählers. Ein Neustart setzt die Zählung fort."
                class="tooltip"
                >?</span
              >
            </td>
            <td><span id="uptime">unbek.</span></td>
          </tr>
          <tr>
            <td>Pumpe:</td>
            <td><span id="filtertime">unbek.</span></td>
          </tr>
          <tr>
            <td>Heizung:</td>
            <td><span id="heatingtime">unbek.</span></td>
          </tr>
          <tr>
            <td>Airjet:</td>
            <td><span id="airtime">unbek.</span></td>
          </tr>
          <tr id="jetstotals">
            <td>Hydrojet:</td>
            <td><span id="jettime">unbek.</span></td>
          </tr>
          <tr>
            <td colspan="2" class="center">
              <button id="reset" class="button" onclick="resetTotals()">
                zurücksetzen
              </button>
            </td>
          </tr>
        </table>
      </section>

      <section id="sectionEnergy">
        <h2>Energie & Kosten</h2>
        <table class="fixed">
          <tr>
            <td>Aktuelle Leistung:</td>
            <td><span id="energy_power">unbek.</span> W</td>
          </tr>
          <tr>
            <td>Energieverbrauch heute:</td>
            <td><span id="energy_today">unbek.</span> kWh</td>
          </tr>
          <tr>
            <td>Gesamtenergieverbrauch:</td>
            <td><span id="energy_total">unbek.</span> kWh</td>
          </tr>
          <tr>
            <td>Geschätzte Kosten:</td>
            <td><span id="cost">unbek.</span> €</td>
          </tr>
        </table>
      </section>

      <footer>
        <div class="center">
          <p><span id="mqtt">MQTT: Lade Status...</span></p>
          <p>
            <span id="rssi2" class="rssi2" data-text="Lade Status...">
              <span id="rssi" class="waveStrength-1">
                <span class="wv4 wave">
                  <span class="wv3 wave">
                    <span class="wv2 wave">
                      <span class="wv1 wave"> </span>
                    </span>
                  </span>
                </span>
              </span>
            </span>
          </p>
          <p><a href="info.html">Softwareinfo</a></p>
        </div>
      </footer>
    </div>

    <script>
      // loading functions from a .js (in the <head> section)
      // and calling the function here can cause problems on laggy connections
      // hence this code
      document.onreadystatechange = function () {
        if (document.readyState == "complete") {
          initApplication();
        }
      };

      function initApplication() {
        if (localStorage.getItem("showSectionTemperature")) {
          setWebConfig();
        } else {
          // Apply alternating backgrounds even if no config exists yet
          updateSectionBackgrounds();
        }
        loadWebConfig();
        connect();
      }

      function setWebConfig() {
        document.getElementById("sectionDisplay").style.display =
          localStorage.getItem("showSectionDisplay") !== "false"
            ? "block"
            : "none";
        document.getElementById("sectionTemperature").style.display =
          localStorage.getItem("showSectionTemperature") !== "false"
            ? "block"
            : "none";
        document.getElementById("sectionControl").style.display =
          localStorage.getItem("showSectionControl") !== "false"
            ? "block"
            : "none";
        document.getElementById("sectionButtons").style.display =
          localStorage.getItem("showSectionButtons") !== "false"
            ? "block"
            : "none";
        document.getElementById("sectionTimer").style.display =
          localStorage.getItem("showSectionTimer") !== "false"
            ? "block"
            : "none";
        document.getElementById("sectionTotals").style.display =
          localStorage.getItem("showSectionTotals") !== "false"
            ? "block"
            : "none";
        document.getElementById("sectionEnergy").style.display =
          localStorage.getItem("showSectionEnergy") !== "false"
            ? "block"
            : "none";
        document.getElementById("sectionWaterQuality").style.display =
          localStorage.getItem("showSectionWaterQuality") !== "false"
            ? "block"
            : "none";
        // Cyanursäure visibility (default: hidden)
        var showCya = localStorage.getItem("showWQCyanuric") === "true";
        document.getElementById("rowCyaValue").style.display = showCya
          ? ""
          : "none";
        document.getElementById("rowCyaInfo").style.display = showCya
          ? ""
          : "none";
        // Alkalinität visibility (default: hidden)
        var showAlk = localStorage.getItem("showWQAlkalinity") === "true";
        document.getElementById("rowAlkValue").style.display = showAlk
          ? ""
          : "none";
        document.getElementById("rowAlkInfo").style.display = showAlk
          ? ""
          : "none";
        document.getElementById("tableSlider").style.display =
          localStorage.getItem("useControlSelector") !== "false"
            ? "none"
            : "table";
        document.getElementById("tableSelector").style.display =
          localStorage.getItem("useControlSelector") !== "false"
            ? "table"
            : "none";
        // Update alternating section backgrounds for visible sections
        updateSectionBackgrounds();
      }

      function updateSectionBackgrounds() {
        var sections = document.querySelectorAll("#site > section");
        var visibleIndex = 0;
        sections.forEach(function (section) {
          section.classList.remove("odd-section");
          // Check computed style since display might not be set inline initially
          var isVisible = window.getComputedStyle(section).display !== "none";
          if (isVisible) {
            if (visibleIndex % 2 === 0) {
              section.classList.add("odd-section");
            }
            visibleIndex++;
          }
        });
      }

      function loadWebConfig() {
        const Http = new XMLHttpRequest();
        const url = "/getwebconfig/";
        Http.open("POST", url);
        Http.send();
        Http.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var json = JSON.parse(Http.responseText);
            localStorage.setItem("showSectionTemperature", json.SST);
            localStorage.setItem("showSectionDisplay", json.SSD);
            localStorage.setItem("showSectionControl", json.SSC);
            localStorage.setItem("showSectionButtons", json.SSB);
            localStorage.setItem("showSectionTimer", json.SSTIM);
            localStorage.setItem("showSectionTotals", json.SSTOT);
            localStorage.setItem(
              "showSectionWaterQuality",
              json.SSWQ !== false,
            );
            localStorage.setItem("showWQCyanuric", json.SWQCYA === true);
            localStorage.setItem("showWQAlkalinity", json.SWQALK === true);
            localStorage.setItem("useControlSelector", json.UCS);
            setWebConfig();
          }
        };
      }

      function resetTotals() {
        if (
          confirm(
            "Möchtest du wirklich alle Zähler zurücksetzen? Dies setzt auch alle Zähler der Energiekosten zurück.",
          )
        ) {
          buttonConfirm(document.getElementById("reset"));
          sendCommand("resetTotals");
        }
      }

      function showpreviewval(val, text) {
        document.getElementById(text).innerHTML = document
          .getElementById(val)
          .value.toString();
      }
    </script>

    <script src="darkmode.js" type="text/javascript"></script>
  </body>
</html>
