<!doctype html>
<html lang="de">
  <head>
    <title>WifiWhirl | Automatisierung</title>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" sizes="180x180" href="logo.png" />
    <meta name="theme-color" content="#4051b5" />
    <link rel="manifest" href="manifest.json" />
    <link
      rel="stylesheet"
      href="main.css"
      onload="
        this.media = 'all';
        this.onload = null;
      "
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />

    <script src="function.js" type="text/javascript"></script>
  </head>

  <body onload="togglefields()">
    <div id="site">
      <header>
        <form id="darkModeForm">
          <label class="switch">
            <input
              type="checkbox"
              id="darkModeToggle"
              onchange="toggleDarkMode()"
            />
            <span class="slider round"></span>
          </label>
        </form>
        <a href="./"
          ><div id="header">
            <span>Automatisierung</span><span id="fw">WifiWhirl</span>
          </div></a
        >
        <a href="javascript:void(0);" class="topnavicon" onclick="topNav()"></a>
      </header>

      <div class="topnav" id="topnav">
        <a href="./">Dashboard</a>
        <a href="automation.html" class="active">Automatisierung</a>
        <a href="smartschedule.html">Smart Schedule</a>
        <a href="config.html">SPA-Konfiguration</a>
        <a href="webconfig.html">Web-Konfiguration</a>
        <a href="mqtt.html">MQTT-Konfiguration</a>
        <a href="wifi.html">Netzwerkkonfiguration</a>
        <a href="hwconfig.html">Pumpenkonfiguration</a>
        <a href="/restart/">WifiWhirl Modul neu starten</a>
      </div>

      <section>
        <h2>Befehl hinzufügen</h2>
        <table>
          <tr>
            <td><label for="commands">Befehl:</label></td>
            <td>
              <select name="commands" id="commands" onchange="togglefields()">
                <option value="4">Filterpumpe ein/aus</option>
                <option value="3">Heizung ein/aus</option>
                <option value="2">Airjet ein/aus</option>
                <option value="11">Hydrojet ein/aus</option>
                <option value="22">Pumpe ein/aus</option>
                <option value="23">Tastensperre ein/aus</option>
                <option value="26">Bedientasten ein/aus</option>
                <option value="12">Displayhelligkeit festlegen</option>
                <option value="19">Text ausgeben</option>
              </select>
            </td>
            <td></td>
          </tr>
          <tr id="valinput">
            <td id="vallabel">ein-/ausschalten:</td>
            <td>
              <input type="radio" id="val" name="val" value="1" /><label
                for="val"
                id="onoffinfo"
                >ein</label
              >
              <input type="radio" id="valoff" name="val" value="0" /><label
                for="valoff"
                id="offinfo"
                >aus</label
              >
            </td>
            <td id="displayinfo">
              <label for="val" id="sliderDsp" valign="middle"></label>
            </td>
          </tr>
          <tr id="textinput" style="display: none">
            <td>
              <label for="txt"
                >Text<br />(nur Kleinbuchstaben und Zahlen):</label
              >
            </td>
            <td>
              <input
                type="text"
                id="txt"
                value=""
                maxlength="24"
                size="16"
                pattern="[a-z0-9-]*"
              />
            </td>
            <td></td>
          </tr>
          <tr>
            <td><label for="xtime">Ausführungszeit:</label><br /></td>
            <td>
              <input
                type="datetime-local"
                id="xtime"
                name="xtime"
                onchange="totimestamp()"
              />
            </td>
            <td></td>
          </tr>
          <tr>
            <td><label for="interval">Wiederholungsintervall:</label></td>
            <td>
              <input type="text" id="interval" value="0" size="8" />
              Stunden
            </td>
            <td></td>
          </tr>
          <tr>
            <td colspan="2">
              <p>(Einmalig ausführen = 0 Stunden)</p>
            </td>
            <td></td>
          </tr>
          <tr>
            <td class="center" colspan="2" style="text-align: center">
              <button
                id="addcmd"
                class="button"
                onclick="
                  buttonConfirm(this);
                  addCommand();
                "
              >
                Hinzufügen
              </button>
            </td>
          </tr>
        </table>
      </section>

      <section style="text-align: left">
        <h2>Befehlswarteschlange</h2>
        <table id="cmdq" width="100%" style="border-spacing: 0">
          <tr class="queueeven">
            <td colspan="2" style="text-align: center">
              Die Warteschlange wird geladen...
            </td>
          </tr>
        </table>
        <table>
          <tr>
            <td class="center">
              <button id="saveq" class="button" onclick="savetofile()">
                Sichern
              </button>
            </td>
            <td class="center">
              <button
                id="loadq"
                class="button"
                onclick="
                  buttonConfirm(this);
                  loadfromfile();
                "
              >
                Wiederherstellen
              </button>
            </td>
          </tr>
          <tr class="center">
            <td class="center" colspan="2" style="text-align: center">
              <button
                id="resetq"
                class="button_red"
                onclick="
                  buttonConfirm(this);
                  resetCommandQueue();
                "
              >
                Warteschlange leeren
              </button>
            </td>
          </tr>
        </table>
      </section>

      <footer>
        <p class="center">
          <span><a href="info.html">Softwareinfo</a></span>
        </p>
      </footer>
    </div>

    <script>
      // Command enum constants (must match backend enums.h)
      const resetq = 5;

      const commandlist = [
        "Zieltemperatur festlegen",
        "Einheit festlegen",
        "Airjet",
        "Heizung",
        "Filterpumpe",
        "Warteschlange zurücksetzen",
        "WLAN Modul neu starten",
        "Interner Befehl",
        "Zeiten zurücksetzen",
        "Chlortimer zurücksetzen",
        "Filtertimer zurücksetzen",
        "Hydrojet",
        "Displayhelligkeit festlegen",
        "Signalton festlegen",
        "Umgebungstemperatur °F festlegen",
        "Umgebungstemperatur °C festlegen",
        "Täglichen Zähler zurücksetzen",
        "Steuerung übernehmen",
        "Volle Leistung",
        "Text ausgeben",
        "Bereitschaftszeit festlegen",
        "",
        "Pumpe festlegen",
        "Tastensperre",
        "",
        "",
        "Bedientasten aktivieren/deaktivieren",
      ];

      // Initialize page
      initPage();

      function initPage() {
        // Check if hardware has jets and hide option if not
        var req = new XMLHttpRequest();
        req.open("POST", "/getconfig/");
        req.send();
        req.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var json = JSON.parse(req.responseText);
            // Hide Hydrojet command if hardware has no jets
            const hydroOption = document.querySelector(
              "#commands option[value='11']",
            );
            if (hydroOption)
              hydroOption.style.display = json.HASJETS ? "" : "none";
          }
        };

        // Start periodic queue refresh
        setInterval(loadCommandQueue, 4000);
        loadCommandQueue();

        // Set default execution time to now
        var now = new Date();
        var offset = now.getTimezoneOffset() * 60000;
        var adjustedDate = new Date(now.getTime() - offset);
        var formattedDate = adjustedDate.toISOString().substring(0, 16);
        var datetimeField = document.getElementById("xtime");
        datetimeField.value = formattedDate;
      }

      function totimestamp() {
        console.log(Date.parse(document.getElementById("xtime").value) / 1000);
        console.log("value " + document.getElementById("xtime").value);
      }

      function showpreviewval(val, text) {
        document.getElementById(text).innerHTML = document
          .getElementById(val)
          .value.toString();
      }

      function togglefields() {
        var select = document.getElementById("commands");
        var textinput = document.getElementById("textinput");
        var varinput = document.getElementById("val");
        var varinput2 = document.getElementById("valoff");
        var varlabel = document.getElementById("vallabel");
        var sliderDsp = document.getElementById("sliderDsp");

        if (select.value == 19) {
          // show text input
          textinput.style.display = "table-row";
          valinput.style.display = "none";
          varinput.value = "1";
          document.getElementById("onoffinfo").style.display = "none";
          document.getElementById("offinfo").style.display = "none";
          document.getElementById("displayinfo").style.display = "none";
        } else if (select.value == 12) {
          // Brightness
          textinput.style.display = "none";
          valinput.style.display = "table-row";
          document.getElementById("displayinfo").style.display = "table-row";
          document.getElementById("onoffinfo").style.display = "none";
          document.getElementById("offinfo").style.display = "none";
          varinput2.style.display = "none";
          varlabel.innerHTML = "Helligkeit:";
          varinput.setAttribute("type", "range");
          varinput.style = "width: 13em;";
          varinput.value = "8";
          varinput.maxlength = "1";
          varinput.min = "0";
          varinput.max = "8";
          varinput.size = "3";
          varinput.removeAttribute("onmousedown");
          varinput.removeAttribute("ontouchend");
          varinput.setAttribute(
            "onmousemove",
            "showpreviewval('val', 'sliderDsp')",
          );
          varinput.setAttribute(
            "ontouchmove",
            "showpreviewval('val', 'sliderDsp')",
          );
          showpreviewval("val", "sliderDsp");
        } else if (
          select.value < 12 ||
          select.value == 23 ||
          select.value == 26
        ) {
          // on off checkbox
          textinput.style.display = "none";
          valinput.style.display = "table-row";
          document.getElementById("onoffinfo").style.display = "inline";
          document.getElementById("offinfo").style.display = "inline";
          document.getElementById("valoff").style.display = "inline";
          document.getElementById("displayinfo").style.display = "none";
          varlabel.innerHTML = "ein-/ausschalten:";
          varinput.setAttribute("type", "radio");
          varinput.checked = true;
          varinput.value = 1;
          varinput.removeAttribute("style");
          varinput.removeAttribute("maxlength");
          varinput.removeAttribute("min");
          varinput.removeAttribute("max");
          varinput.removeAttribute("size");
          varinput.removeAttribute("onmousemove");
          varinput.removeAttribute("ontouchmove");
          varinput.setAttribute(
            "onmousedown",
            "(this.value = this.checked ? 0 : 1)",
          );
          varinput.setAttribute(
            "ontouchend",
            "(this.value = this.checked ? 0 : 1)",
          );
        }
      }

      function getCommandJson() {
        // Safely determine the value for the VALUE field
        let valueToSend;
        const commandValue = parseInt(
          document.getElementById("commands").value,
        );
        if (commandValue === 12) {
          // Case for command 12 (brightness slider)
          const inputElement = document.querySelector('input[name="val"]');
          valueToSend = inputElement ? parseFloat(inputElement.value) : 0;
        } else {
          // Case for other commands (on/off radio buttons)
          const checkedInput = document.querySelector(
            'input[name="val"]:checked',
          );
          valueToSend = checkedInput ? parseFloat(checkedInput.value) : 0;
        }
        // Safely parse time and interval, providing defaults if parsing fails
        const parsedTime =
          Date.parse(document.getElementById("xtime").value) / 1000;
        const xtimeToSend = isNaN(parsedTime) ? 0 : parsedTime;

        const parsedInterval =
          parseInt(document.getElementById("interval").value) * 3600;
        const intervalToSend = isNaN(parsedInterval) ? 0 : parsedInterval;

        return {
          CMD: commandValue,
          VALUE: valueToSend,
          XTIME: xtimeToSend,
          INTERVAL: intervalToSend,
          TXT: document.getElementById("txt").value,
        };
      }

      let dateoptions = {
        weekday: "long",
        year: "numeric",
        month: "numeric",
        day: "numeric",
        hour: "numeric",
        minute: "numeric",
        hour12: false,
      };

      function loadCommandQueue() {
        var req = new XMLHttpRequest();
        req.open("POST", "/getcommands/");
        req.send();
        req.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var json = JSON.parse(req.responseText);
            console.log(json);
            var table = document.getElementById("cmdq");
            table.innerHTML = "";
            if (json.LEN == 0) {
              var row = table.insertRow();
              row.className = "queueeven";
              var cell = row.insertCell(0);
              cell.colSpan = "2";
              cell.style = "text-align: center;";
              cell.innerHTML = "Die Warteschlange ist leer.";
              return;
            }
            for (var i = 0; i < json.LEN; i++) {
              var row = table.insertRow();
              if (i % 2) {
                row.className = "queueodd";
              } else {
                row.className = "queueeven";
              }
              var cell = row.insertCell(0);
              cell.colSpan = "2";
              cell.style = "padding: 0.5em;";
              var date = new Date(json.XTIME[i] * 1000);
              cell.innerHTML =
                "<strong>" +
                commandlist[json["CMD"][i]] +
                " " +
                (json["VALUE"][i] == 1
                  ? "einschalten"
                  : json["VALUE"][i] == 0
                    ? "ausschalten"
                    : json["VALUE"][i]) +
                "</strong><br>" +
                "Nächste Ausführung: " +
                new Intl.DateTimeFormat(undefined, dateoptions).format(date) +
                "<br>Wiederholungsintervall: " +
                (json["INTERVAL"][i] != 0
                  ? json["INTERVAL"][i] / 3600 +
                    " Stunde" +
                    (json["INTERVAL"][i] / 3600 != 1 ? "n" : "")
                  : "einmalig");
              var row = table.insertRow();
              if (i % 2) {
                row.className = "queueodd";
              } else {
                row.className = "queueeven";
              }
              cell = row.insertCell(0);
              cell.width = "50%";
              cell.style = "padding: 0.5em; text-align: center;";
              cell.innerHTML =
                '<button id="editCmd' +
                i +
                '" class="button" onclick="editCommandQueue(' +
                i +
                ')">Überschreiben</button>';
              cell = row.insertCell(1);
              cell.width = "50%";
              cell.style = "padding: 0.5em; text-align: center;";
              cell.innerHTML =
                '<button id="delCmd' +
                i +
                '" class="button_red" onclick="delCommand(' +
                i +
                ')">Löschen</button>';
            }
          }
        };
      }

      function addCommand() {
        var req = new XMLHttpRequest();
        req.open("POST", "/addcommand/");
        var json = getCommandJson();
        req.send(JSON.stringify(json));
        console.log(json);
      }

      function resetCommandQueue() {
        if (
          !confirm(
            "Möchtest du die Warteschlange wirklich leeren? Alle geplanten Befehle werden gelöscht.",
          )
        ) {
          return;
        }
        var req = new XMLHttpRequest();
        req.open("POST", "/addcommand/");
        var json = {
          CMD: resetq,
          VAL: 1,
          XTIME: 0,
          INTERVAL: 0,
        };
        req.send(JSON.stringify(json));
        console.log(json);
        loadCommandQueue();
      }

      function savetofile() {
        // Fetch cmdq.json from backend and download to user's device
        var req = new XMLHttpRequest();
        req.open("POST", "/cmdq_file/");
        req.setRequestHeader("Content-Type", "application/json");
        req.onreadystatechange = function () {
          if (req.readyState === 4) {
            if (req.status === 200) {
              // Generate filename with datetime
              var now = new Date();
              var datetime =
                now.getFullYear() +
                String(now.getMonth() + 1).padStart(2, "0") +
                String(now.getDate()).padStart(2, "0") +
                "_" +
                String(now.getHours()).padStart(2, "0") +
                String(now.getMinutes()).padStart(2, "0") +
                String(now.getSeconds()).padStart(2, "0");
              var filename = "wifiwhirl_queue_" + datetime + ".json";

              // Create blob and trigger download
              var blob = new Blob([req.responseText], {
                type: "application/json",
              });
              var link = document.createElement("a");
              link.href = window.URL.createObjectURL(blob);
              link.download = filename;
              link.click();
              window.URL.revokeObjectURL(link.href);
            } else {
              alert("Fehler beim Herunterladen der Warteschlange.");
            }
          }
        };
        req.send(JSON.stringify({ ACT: "download" }));
      }

      function loadfromfile() {
        // Create hidden file input and trigger it
        var fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = ".json";
        fileInput.style.display = "none";
        fileInput.onchange = function (e) {
          var file = e.target.files[0];
          if (!file) return;

          var reader = new FileReader();
          reader.onload = function (event) {
            var content = event.target.result;

            // Send raw file content to backend for validation and storage
            var req = new XMLHttpRequest();
            req.open("POST", "/cmdq_file/?action=upload");
            req.setRequestHeader("Content-Type", "application/json");
            req.onreadystatechange = function () {
              if (req.readyState === 4) {
                if (req.status === 200) {
                  alert("Warteschlange erfolgreich wiederhergestellt!");
                  location.reload();
                } else {
                  alert("Fehler: " + req.responseText);
                }
              }
            };
            req.send(content);
          };
          reader.readAsText(file);
        };
        document.body.appendChild(fileInput);
        fileInput.click();
        document.body.removeChild(fileInput);
      }

      function editCommandQueue(index) {
        var req = new XMLHttpRequest();
        req.open("POST", "/editcommand/");
        var json = getCommandJson();
        json.IDX = index;
        req.send(JSON.stringify(json));
        console.log(json);
      }

      function delCommand(index) {
        var req = new XMLHttpRequest();
        req.open("POST", "/delcommand/");
        var json = {
          IDX: index,
        };
        req.send(JSON.stringify(json));
        console.log(json);
      }
    </script>
    <script src="darkmode.js"></script>
  </body>
</html>
