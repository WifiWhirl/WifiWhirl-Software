<!doctype html>
<html lang="de">
  <head>
    <title>WifiWhirl | SPA-Konfiguration</title>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" sizes="180x180" href="logo.png" />
    <meta name="theme-color" content="#4051b5" />
    <link rel="manifest" href="manifest.json" />
    <link
      rel="stylesheet"
      href="main.css"
      onload="
        this.media = 'all';
        this.onload = null;
      "
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />

    <script src="function.js" type="text/javascript"></script>
    <style>
      /* Hide number input spinners and normalize Safari mobile styling */
      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
        -webkit-appearance: none;
        appearance: none;
        width: 4em;
      }
      /* Input + unit wrapper: keeps value and unit on one line */
      .input-group {
        display: inline-flex;
        align-items: baseline;
        gap: 0.4em;
        white-space: nowrap;
      }
    </style>
  </head>

  <body>
    <div id="site">
      <header>
        <form id="darkModeForm">
          <label class="switch">
            <input
              type="checkbox"
              id="darkModeToggle"
              onchange="toggleDarkMode()"
            />
            <span class="slider round"></span>
          </label>
        </form>
        <a href="./"
          ><div id="header">
            <span>SPA-Konfiguration</span><span id="fw">WifiWhirl</span>
          </div></a
        >
        <a href="javascript:void(0);" class="topnavicon" onclick="topNav()"></a>
      </header>

      <div class="topnav" id="topnav">
        <a href="./">Dashboard</a>
        <a href="automation.html">Automatisierung</a>
        <a href="smartschedule.html">Smart Schedule</a>
        <a href="config.html" class="active">SPA-Konfiguration</a>
        <a href="webconfig.html">Web-Konfiguration</a>
        <a href="mqtt.html">MQTT-Konfiguration</a>
        <a href="wifi.html">Netzwerkkonfiguration</a>
        <a href="hwconfig.html">Pumpenkonfiguration</a>
        <a href="/restart/">WifiWhirl Modul neu starten</a>
      </div>

      <section>
        <table>
          <tr>
            <td><label for="price">Preis pro kWh:</label></td>
            <td>
              <span class="input-group"><input
                type="number"
                id="price"
                value="0.35"
                min="0"
                max="9.99"
                step="0.01"
                inputmode="decimal"
                required
              /><span class="inputunit">€</span></span>
            </td>
            <td></td>
          </tr>
          <tr>
            <td><label for="clinterval">Chlor hinzufügen:</label></td>
            <td>
              <span class="input-group"><input
                type="number"
                id="clinterval"
                value="7"
                min="1"
                max="99"
                step="1"
                inputmode="numeric"
                required
              /><span class="inputunit">Tage</span></span>
            </td>
            <td></td>
          </tr>
          <tr>
            <td><label for="finterval">Filterreinigung:</label></td>
            <td>
              <span class="input-group"><input
                type="number"
                id="finterval"
                value="30"
                min="1"
                max="99"
                step="1"
                inputmode="numeric"
                required
              /><span class="inputunit">Tage</span></span>
            </td>
            <td></td>
          </tr>
          <tr>
            <td><label for="fcinterval">Filterwechsel:</label></td>
            <td>
              <span class="input-group"><input
                type="number"
                id="fcinterval"
                value="60"
                min="1"
                max="99"
                step="1"
                inputmode="numeric"
                required
              /><span class="inputunit">Tage</span></span>
            </td>
            <td></td>
          </tr>
          <tr>
            <td><label for="wcinterval">Wasserwechsel:</label></td>
            <td>
              <span class="input-group"><input
                type="number"
                id="wcinterval"
                value="90"
                min="1"
                max="99"
                step="1"
                inputmode="numeric"
                required
              /><span class="inputunit">Tage</span></span>
            </td>
            <td></td>
          </tr>
          <tr>
            <td><label for="poolCap">Poolinhalt in Liter:</label></td>
            <td>
              <span class="input-group"><input
                type="number"
                id="poolCap"
                value="700"
                min="100"
                max="9999"
                step="1"
                inputmode="numeric"
                required
              /><span class="inputunit">Liter</span></span>
            </td>
            <td></td>
          </tr>
          <tr>
            <td><label for="audio">Töne (ein/aus):</label></td>
            <td><input type="checkbox" id="audio" /></td>
            <td></td>
          </tr>
          <tr>
            <td>
              <label for="airjetTimeout">Airjet Timeout:</label>
              <span
                data-text="Maximale Laufzeit der Luftdüsen. Standard ist 30 Minuten (Hardware-Limit). Bei niedrigerer Einstellung schaltet WifiWhirl die Luftdüsen automatisch ab."
                class="tooltip"
                >?</span
              >
            </td>
            <td>
              <span class="input-group"><input
                type="number"
                id="airjetTimeout"
                min="5"
                max="30"
                value="30"
                size="6"
                inputmode="numeric"
              /><span class="inputunit">Min</span></span>
            </td>
            <td></td>
          </tr>
          <tr id="hydrojetTimeoutRow">
            <td>
              <label for="hydrojetTimeout">Hydrojet Timeout:</label>
              <span
                data-text="Maximale Laufzeit der Wasserdüsen. Standard ist 60 Minuten (Hardware-Limit). Bei niedrigerer Einstellung schaltet WifiWhirl die Wasserdüsen automatisch ab."
                class="tooltip"
                >?</span
              >
            </td>
            <td>
              <span class="input-group"><input
                type="number"
                id="hydrojetTimeout"
                min="5"
                max="60"
                value="60"
                size="6"
                inputmode="numeric"
              /><span class="inputunit">Min</span></span>
            </td>
            <td></td>
          </tr>
          <!-- <tr>
            <td>
              <label for="calibration">Kalibriert:</label
              ><span
                data-text="Wenn aktiviert, ist die virtuelle Temperatur kalibriert. Kalibrieren: Schalte die Heizung AUS und die Pumpe EIN. Stoppe die Zeit, bis die Temperatur um einige Grad gesunken ist. Schalte währenddessen keine Air- oder Hydrojets ein. Die Wassertemperatur muss sich zu Beginn um mehrere Grad von der Umgebungstemperatur unterscheiden."
                class="tooltip"
                >?</span
              >
            </td>
            <td>
              <input
                type="checkbox"
                id="calibration"
                onclick="toggleCalibration()"
              />
            </td>
          </tr> -->
          <!-- <tr>
            <td></td>
            <td><a href="calib.html">manuelle Kalibrierung</a></td>
          </tr> -->
          <tr>
            <td>
              <label for="enableWeather"
                >Außentemperatur automatisch ermitteln:</label
              >
              <span
                data-text="Mit der Ermittlung der Außentemperatur wird die Umgebungstemperatur automatisch gesetzt. Dies sollte nicht aktiviert werden, wenn der Pool im Innenraum steht."
                class="tooltip"
                >?</span
              >
            </td>
            <td>
              <input
                type="checkbox"
                id="enableWeather"
                onclick="toggleWeatherSettings()"
              />
            </td>
          </tr>

          <tr id="coordinates" style="display: none">
            <td>Postleitzahl:</td>
            <td>
              <input type="text" inputmode="numeric" id="plz" maxlength="5" size="6" />
            </td>
          </tr>
          <tr id="cityhintrow">
            <td colspan="2" id="cityhint" style="display: none">
              Die Temperatur wird für <span id="city">...</span> ermittelt.
            </td>
          </tr>
        </table>
      </section>
      <section>
        <table>
          <tr>
            <td colspan="8">
              Aktivierte Bedientasten | <label for="toggle_all">Alle:</label>
              <input
                type="checkbox"
                id="toggle_all"
                onchange="
                  confirmDisable(this);
                  toggleAll();
                "
              />
            </td>
          </tr>
          <tr>
            <td>
              <input
                type="checkbox"
                id="power_btn"
                onchange="confirmDisable(this)"
              />
            </td>
            <td><label for="power_btn">Ein/Aus</label></td>
            <td>
              <input
                type="checkbox"
                id="lock_btn"
                onchange="confirmDisable(this)"
              />
            </td>
            <td><label for="lock_btn">Tastensperre</label></td>
            <td>
              <input
                type="checkbox"
                id="bubbles_btn"
                onchange="confirmDisable(this)"
              />
            </td>
            <td><label for="bubbles_btn">Airjet</label></td>
            <td>
              <input
                type="checkbox"
                id="hydrojets_btn"
                onchange="confirmDisable(this)"
              />
            </td>
            <td><label for="hydrojets_btn">Hydrojet</label></td>
          </tr>
          <tr>
            <td>
              <input
                type="checkbox"
                id="pump_btn"
                onchange="confirmDisable(this)"
              />
            </td>
            <td><label for="pump_btn">Pumpe</label></td>
            <td>
              <input
                type="checkbox"
                id="up_btn"
                onchange="confirmDisable(this)"
              />
            </td>
            <td><label for="up_btn">Aufwärts</label></td>
            <td>
              <input
                type="checkbox"
                id="timer_btn"
                onchange="confirmDisable(this)"
              />
            </td>
            <td><label for="timer_btn">Timer</label></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td>
              <input
                type="checkbox"
                id="heat_btn"
                onchange="confirmDisable(this)"
              />
            </td>
            <td><label for="heat_btn">Heizung</label></td>
            <td>
              <input
                type="checkbox"
                id="down_btn"
                onchange="confirmDisable(this)"
              />
            </td>
            <td><label for="down_btn">Abwärts</label></td>
            <td>
              <input
                type="checkbox"
                id="unit_btn"
                onchange="confirmDisable(this)"
              />
            </td>
            <td><label for="unit_btn">Einheit</label></td>
            <td></td>
            <td></td>
          </tr>
        </table>
        <div class="center">
          <button
            id="save"
            class="button"
            onclick="
              buttonConfirm(this);
              saveConfig();
            "
          >
            Speichern
          </button>
        </div>
      </section>

      <footer>
        <p class="center" id="lastboot">Letzter Neustart: wird geladen...</p>
        <p class="center">
          <span><a href="info.html">Softwareinfo</a></span>
        </p>
      </footer>
    </div>

    <script>
      var weatherEnabled = 0;
      loadConfig();
      toggleWeatherSettings();
      loadWeatherCity();

      function loadWeatherCity() {
        if (!weatherEnabled) return;
        let cityhint = document.getElementById("cityhint");
        var req = new XMLHttpRequest();
        req.open("GET", "/getweather/");
        req.send();
        req.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            console.log(req.responseText);
            cityhint.style.display = "table-cell";
            cityhint.innerHTML =
              "Die Temperatur wird für <span id='city'>...</span> ermittelt.";
            document.getElementById("city").innerHTML = req.responseText;
          }
          if (this.readyState == 4 && this.status == 500) {
            console.log(req.responseText);
            cityhint.style.display = "table-cell";
            cityhint.innerHTML =
              "Es ist ein Fehler aufgetreten. Bitte prüfe die eingegebene Postleitzahl. Die aktuelle Temperatur kann nur für deutsche und österreichische Postleitzahlen ermittelt werden.";
          }
        };
      }

      function loadConfig() {
        var req = new XMLHttpRequest();
        req.open("POST", "/getconfig/");
        req.send();
        req.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            var json = JSON.parse(req.responseText);
            console.log(json);
            //document.getElementById('timezone').value = json.TIMEZONE.toString();
            document.getElementById("price").value = json.PRICE.toFixed(2);
            document.getElementById("clinterval").value = json.CLINT.toString();
            document.getElementById("finterval").value = json.FINT.toString();
            document.getElementById("fcinterval").value = json.FCINT.toString();
            document.getElementById("wcinterval").value = json.WCINT.toString();
            document.getElementById("audio").checked = json.AUDIO;
            var date = new Date(json.REBOOTTIME * 1000);
            document.getElementById("lastboot").innerHTML =
              "Letzter Neustart: " + date.toLocaleString();
            // document.getElementById("calibration").checked = json.VTCAL;
            document.getElementById("plz").value = json.PLZ;
            document.getElementById("enableWeather").checked = json.WEATHER;
            weatherEnabled = json.WEATHER;

            // Hide Hydrojet enable-checkboxes if no jets available
            const hydroCheckboxCell =
              document.getElementById("hydrojets_btn")?.parentElement;
            const hydroLabelCell = document.querySelector(
              "label[for='hydrojets_btn']",
            )?.parentElement;
            const displayState = json.HASJETS ? "" : "none";
            if (hydroCheckboxCell)
              hydroCheckboxCell.style.display = displayState;
            if (hydroLabelCell) hydroLabelCell.style.display = displayState;

            // Hide Hydrojet timeout row if no jets available
            const hydrojetTimeoutRow =
              document.getElementById("hydrojetTimeoutRow");
            if (hydrojetTimeoutRow)
              hydrojetTimeoutRow.style.display = displayState;

            document.getElementById("poolCap").value = json.POOLCAP;
            document.getElementById("airjetTimeout").value = json.AIRTO || 30;
            document.getElementById("hydrojetTimeout").value = json.HJTO || 60;
            document.getElementById("lock_btn").checked = json.LCK;
            document.getElementById("timer_btn").checked = json.TMR;
            document.getElementById("bubbles_btn").checked = json.AIR;
            document.getElementById("unit_btn").checked = json.UNT;
            document.getElementById("heat_btn").checked = json.HTR;
            document.getElementById("pump_btn").checked = json.FLT;
            document.getElementById("down_btn").checked = json.DN;
            document.getElementById("up_btn").checked = json.UP;
            document.getElementById("power_btn").checked = json.PWR;
            document.getElementById("hydrojets_btn").checked = json.HJT;
            if (json.WEATHER) loadWeatherCity();
            toggleWeatherSettings();
          }
        };
      }

      function saveConfig() {
        var req = new XMLHttpRequest();
        req.open("POST", "/setconfig/");

        var json = {
          TIMEZONE: 0,
          PRICE: parseFloat(
            document.getElementById("price").value,
          ).toFixed(2),
          CLINT: parseInt(document.getElementById("clinterval").value),
          FINT: parseInt(document.getElementById("finterval").value),
          FCINT: parseInt(document.getElementById("fcinterval").value),
          WCINT: parseInt(document.getElementById("wcinterval").value),
          AUDIO: document.getElementById("audio").checked,
          PLZ: document.getElementById("plz").value,
          WEATHER: document.getElementById("enableWeather").checked,
          POOLCAP: document.getElementById("poolCap").value,
          AIRTO: parseInt(document.getElementById("airjetTimeout").value) || 30,
          HJTO:
            parseInt(document.getElementById("hydrojetTimeout").value) || 60,
          LCK: document.getElementById("lock_btn").checked,
          TMR: document.getElementById("timer_btn").checked,
          AIR: document.getElementById("bubbles_btn").checked,
          UNT: document.getElementById("unit_btn").checked,
          HTR: document.getElementById("heat_btn").checked,
          FLT: document.getElementById("pump_btn").checked,
          DN: document.getElementById("down_btn").checked,
          UP: document.getElementById("up_btn").checked,
          PWR: document.getElementById("power_btn").checked,
          HJT: document.getElementById("hydrojets_btn").checked,
        };

        var jsonstring = JSON.stringify(json);
        req.send(jsonstring);
        console.log(jsonstring);

        if (document.getElementById("enableWeather").checked) {
          weatherEnabled = 1;
          loadWeatherCity();
        }
        toggleWeatherSettings();
      }

      function toggleAll() {
        document.getElementById("lock_btn").checked =
          document.getElementById("toggle_all").checked;
        document.getElementById("timer_btn").checked =
          document.getElementById("toggle_all").checked;
        document.getElementById("bubbles_btn").checked =
          document.getElementById("toggle_all").checked;
        document.getElementById("unit_btn").checked =
          document.getElementById("toggle_all").checked;
        document.getElementById("heat_btn").checked =
          document.getElementById("toggle_all").checked;
        document.getElementById("pump_btn").checked =
          document.getElementById("toggle_all").checked;
        document.getElementById("down_btn").checked =
          document.getElementById("toggle_all").checked;
        document.getElementById("up_btn").checked =
          document.getElementById("toggle_all").checked;
        document.getElementById("power_btn").checked =
          document.getElementById("toggle_all").checked;
        document.getElementById("hydrojets_btn").checked =
          document.getElementById("toggle_all").checked;
      }

      function toggleWeatherSettings() {
        let obj = document.getElementById("coordinates");
        let cityhint = document.getElementById("cityhint");
        if (document.getElementById("enableWeather").checked) {
          obj.style.display = "table-row";
          if (weatherEnabled) cityhint.style.display = "table-cell";
        } else {
          weatherEnabled = 0;
          if (!weatherEnabled) cityhint.style.display = "none";
          obj.style.display = "none";
        }
      }

      function confirmDisable(elem) {
        if (elem.checked) return; // only on uncheck
        var label = document.querySelector("label[for='" + elem.id + "']");
        var btnName = label ? label.innerText.trim() : elem.id;
        var msg =
          "Achtung!\n\nMit dem Deaktivieren der Bedientasten ist eine Steuerung nur noch über das WifiWhirl Modul möglich. " +
          "Die Bedientasten auf der Pumpe werden damit deaktiviert!\n\nBist du dir sicher, dass du ";

        if (btnName === "Alle:") {
          msg += "ALLE Tasten deaktivieren möchtest?";
        } else {
          msg += 'die Taste "' + btnName + '" deaktivieren möchtest?';
        }
        if (!confirm(msg)) {
          elem.checked = true; // revert change
        }
      }
    </script>
    <script src="darkmode.js"></script>
  </body>
</html>
